import { create } from 'zustand';
import { persist } from 'zustand/middleware';
export type ExceptionType = '设备故障' | '试剂异常' | '样本异常' | '操作异常';
export type ExceptionStatus = '待处理' | '处理中' | '已解决' | '已关闭';
export interface RoutineExceptionRecord { id: string; exceptionNo: string; experimentNo: string; sampleNo: string; productName: string; testItemName?: string; type: ExceptionType; status: ExceptionStatus; discoverer?: string; discoverTime?: string; handler?: string; handleTime?: string; }
export interface ExceptionFilters { exceptionNos?: string[]; experimentNos?: string[]; sampleNos?: string[]; productIds?: string[]; testItemIds?: string[]; types?: ExceptionType[]; statuses?: ExceptionStatus[]; discoverers?: string[]; handlers?: string[]; discoverRange?: [string, string]; handleRange?: [string, string]; }
export interface PaginationConfig { current: number; pageSize: number; total: number; showSizeChanger: boolean; pageSizeOptions: string[]; }
interface ExceptionState { records: RoutineExceptionRecord[]; filteredRecords: RoutineExceptionRecord[]; selectedRowKeys: string[]; filters: ExceptionFilters; pagination: PaginationConfig; loading: boolean; }
interface ExceptionActions { setRecords: (records: RoutineExceptionRecord[]) => void; setFilteredRecords: (records: RoutineExceptionRecord[]) => void; setSelectedRowKeys: (keys: string[]) => void; setFilters: (filters: Partial<ExceptionFilters>) => void; resetFilters: () => void; setPagination: (pagination: Partial<PaginationConfig>) => void; query: () => void; markException: (ids: string[]) => void; retest: (ids: string[]) => void; close: (ids: string[]) => void; }
const defaultFilters: ExceptionFilters = { types: ['设备故障','试剂异常','样本异常','操作异常'], statuses: ['待处理','处理中','已解决','已关闭'] };
const defaultPagination: PaginationConfig = { current: 1, pageSize: 20, total: 0, showSizeChanger: true, pageSizeOptions: ['10','20','50','100'] };
const mock: RoutineExceptionRecord[] = [ { id: 'e1', exceptionNo: 'EX001', experimentNo: 'EXP001', sampleNo: 'SMP001', productName: '外显子组测序', testItemName: '覆盖度', type: '设备故障', status: '待处理', discoverer: 'techA', discoverTime: new Date().toISOString() }, { id: 'e2', exceptionNo: 'EX010', experimentNo: 'EXP010', sampleNo: 'SMP020', productName: '肿瘤标志物检测', testItemName: '样本体积', type: '样本异常', status: '已解决', discoverer: 'techB', discoverTime: new Date().toISOString(), handler: 'techC', handleTime: new Date().toISOString() } ];
export const useRoutineExceptionStore = create<ExceptionState & ExceptionActions>()(persist((set, get) => ({ records: mock, filteredRecords: [], selectedRowKeys: [], filters: defaultFilters, pagination: defaultPagination, loading: false, setRecords: (records) => set({ records }), setFilteredRecords: (filteredRecords) => set({ filteredRecords }), setSelectedRowKeys: (selectedRowKeys) => set({ selectedRowKeys }), setFilters: (filters) => set((state) => ({ filters: { ...state.filters, ...filters } })), resetFilters: () => set({ filters: defaultFilters }), setPagination: (pagination) => set((state) => ({ pagination: { ...state.pagination, ...pagination } })), query: () => { const { records, filters, pagination } = get(); let list = [...records]; if (filters.exceptionNos?.length) { list = list.filter(r => filters.exceptionNos!.some(no => r.exceptionNo.includes(no))); } if (filters.experimentNos?.length) { list = list.filter(r => filters.experimentNos!.some(no => r.experimentNo.includes(no))); } if (filters.sampleNos?.length) { list = list.filter(r => filters.sampleNos!.some(no => r.sampleNo.includes(no))); } if (filters.productIds?.length) { list = list.filter(r => filters.productIds!.some(pid => r.productName.includes(pid))); } if (filters.testItemIds?.length) { list = list.filter(r => filters.testItemIds!.some(tid => (r.testItemName || '').includes(tid))); } if (filters.types?.length) { list = list.filter(r => filters.types!.includes(r.type)); } if (filters.statuses?.length) { list = list.filter(r => filters.statuses!.includes(r.status)); } if (filters.discoverers?.length) { list = list.filter(r => r.discoverer && filters.discoverers!.includes(r.discoverer)); } if (filters.handlers?.length) { list = list.filter(r => r.handler && filters.handlers!.includes(r.handler)); } if (filters.discoverRange?.[0] && filters.discoverRange?.[1]) { const [start, end] = filters.discoverRange; list = list.filter(r => r.discoverTime ? new Date(r.discoverTime) >= new Date(start) && new Date(r.discoverTime) <= new Date(end) : false); } if (filters.handleRange?.[0] && filters.handleRange?.[1]) { const [start, end] = filters.handleRange; list = list.filter(r => r.handleTime ? new Date(r.handleTime) >= new Date(start) && new Date(r.handleTime) <= new Date(end) : false); } list.sort((a, b) => (b.discoverTime ? new Date(b.discoverTime).getTime() : 0) - (a.discoverTime ? new Date(a.discoverTime).getTime() : 0)); const startIdx = (pagination.current - 1) * pagination.pageSize; const endIdx = startIdx + pagination.pageSize; const page = list.slice(startIdx, endIdx); set({ filteredRecords: page, pagination: { ...pagination, total: list.length } }); }, markException: (ids) => { set((state) => ({ selectedRowKeys: state.selectedRowKeys.filter(k => !ids.includes(k)) })); }, retest: (ids) => { set((state) => ({ records: state.records.map(r => ids.includes(r.id) ? { ...r, status: '待处理' } : r), selectedRowKeys: state.selectedRowKeys.filter(k => !ids.includes(k)) })); }, close: (ids) => { set((state) => ({ records: state.records.map(r => ids.includes(r.id) ? { ...r, status: '已关闭', handleTime: new Date().toISOString(), handler: 'admin' } : r), selectedRowKeys: state.selectedRowKeys.filter(k => !ids.includes(k)) })); } }), { name: 'routine-exception-store', partialize: (state) => ({ records: state.records, filters: state.filters, pagination: state.pagination }) }));
export type { ExceptionState, ExceptionActions };

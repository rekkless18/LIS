# 套餐、产品、检测项数据库设计（Supabase/PostgreSQL）

## 1. 目标与范围
- 覆盖“产品配置”“套餐配置”“检测项配置”三类页面的后端数据模型
- 支持产品、检测项的类型枚举与启用/禁用状态管理
- 支持套餐与产品+样本类型的组合绑定
- 支持检测项的结果判断类型配置（上限/下限/上下限/定性/阴阳性/聚合）

## 2. 表清单与关联说明
- products（产品表）
- test_items（检测项表）
- packages（套餐表）
- package_products（套餐-产品绑定表，包含样本类型）
- test_item_aggregate_rules（聚合型检测项的子项绑定与判断配置表）

关联关系说明：
- packages 1..* products（经由 package_products，并携带样本类型）
- products 可在业务上与 test_items 关联（具体页面中为选择引用关系，不强制数据库外键绑定）
- test_items 若为“聚合”，经由 test_item_aggregate_rules 绑定多个子检测项并设定判断条件与结果

## 3. 字段详细设计

### 3.1 products（产品表）
- id：uuid，主键，默认 `gen_random_uuid()`
- product_code：text，产品编码，唯一
- product_name：text，产品名称
- product_type：text，枚举（'普检产品','特检产品','质谱产品','研发产品','其他产品'）
- status：text，枚举（enabled/disabled），默认 `enabled`
- created_at：timestamptz，默认 `now()`
- updated_at：timestamptz，默认 `now()`

示例DDL：
```sql
create extension if not exists pgcrypto;

create table if not exists products (
  id uuid primary key default gen_random_uuid(),
  product_code text not null,
  product_name text not null,
  product_type text not null check (product_type in ('普检产品','特检产品','质谱产品','研发产品','其他产品')),
  status text not null check (status in ('enabled','disabled')) default 'enabled',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_products_code unique (product_code)
);
create index if not exists idx_products_name on products(product_name);
```

### 3.2 test_items（检测项表）
- id：uuid，主键，默认 `gen_random_uuid()`
- item_code：text，检测项编码，唯一
- item_name：text，检测项名称
- item_type：text，枚举（'普检检测项','特检检测项','质谱检测项','研发检测项','其他检测项'）
- judgement_type：text，枚举（'上限','下限','上下限','定性','阴阳性','聚合'）
- limit_upper：numeric，可空；用于'上限'/'上下限'
- limit_lower：numeric，可空；用于'下限'/'上下限'
- unit：text，可空；用于数值类（上/下/上下限）
- qualitative_value：text，可空；用于'定性'与'阴阳性'
- status：text，枚举（enabled/disabled），默认 `enabled`
- created_at：timestamptz，默认 `now()`
- updated_at：timestamptz，默认 `now()`

示例DDL：
```sql
create table if not exists test_items (
  id uuid primary key default gen_random_uuid(),
  item_code text not null,
  item_name text not null,
  item_type text not null check (item_type in ('普检检测项','特检检测项','质谱检测项','研发检测项','其他检测项')),
  judgement_type text not null check (judgement_type in ('上限','下限','上下限','定性','阴阳性','聚合')),
  limit_upper numeric,
  limit_lower numeric,
  unit text,
  qualitative_value text,
  status text not null check (status in ('enabled','disabled')) default 'enabled',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_test_items_code unique (item_code)
);
create index if not exists idx_test_items_name on test_items(item_name);
create index if not exists idx_test_items_type on test_items(item_type);
```

### 3.3 packages（套餐表）
- id：uuid，主键，默认 `gen_random_uuid()`
- package_code：text，套餐编码，唯一
- package_name：text，套餐名称
- package_type：text，枚举（'常规套餐','科研套餐','VIP套餐'）
- status：text，枚举（enabled/disabled），默认 `enabled`
- created_at：timestamptz，默认 `now()`
- updated_at：timestamptz，默认 `now()`

示例DDL：
```sql
create table if not exists packages (
  id uuid primary key default gen_random_uuid(),
  package_code text not null,
  package_name text not null,
  package_type text not null check (package_type in ('常规套餐','科研套餐','VIP套餐')),
  status text not null check (status in ('enabled','disabled')) default 'enabled',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_packages_code unique (package_code)
);
create index if not exists idx_packages_name on packages(package_name);
```

### 3.4 package_products（套餐-产品绑定表，含样本类型）
- id：uuid，主键，默认 `gen_random_uuid()`
- package_id：uuid，外键 `packages(id)`
- product_id：uuid，外键 `products(id)`
- sample_type：text，枚举（'全血','血浆','组织液','尿液','切片'）
- created_at：timestamptz，默认 `now()`

示例DDL：
```sql
create table if not exists package_products (
  id uuid primary key default gen_random_uuid(),
  package_id uuid not null references packages(id) on delete cascade,
  product_id uuid not null references products(id) on delete cascade,
  sample_type text not null check (sample_type in ('全血','血浆','组织液','尿液','切片')),
  created_at timestamptz not null default now(),
  constraint uniq_package_product_sample unique (package_id, product_id, sample_type)
);
create index if not exists idx_package_products_package on package_products(package_id);
create index if not exists idx_package_products_product on package_products(product_id);
```

### 3.5 test_item_aggregate_rules（聚合型检测项的子项绑定与判断配置）
- id：uuid，主键，默认 `gen_random_uuid()`
- parent_item_id：uuid，外键 `test_items(id)`（父项的 judgement_type 必须为'聚合'）
- child_item_id：uuid，外键 `test_items(id)`（被聚合的子检测项）
- condition：text，枚举（'任意满足','所有满足','任意不满足','所有不满足'）
- result：text，枚举（'偏高','偏低','正常','异常'）
- created_at：timestamptz，默认 `now()`

示例DDL：
```sql
create table if not exists test_item_aggregate_rules (
  id uuid primary key default gen_random_uuid(),
  parent_item_id uuid not null references test_items(id) on delete cascade,
  child_item_id uuid not null references test_items(id) on delete cascade,
  condition text not null check (condition in ('任意满足','所有满足','任意不满足','所有不满足')),
  result text not null check (result in ('偏高','偏低','正常','异常')),
  created_at timestamptz not null default now(),
  constraint uniq_agg_rule unique (parent_item_id, child_item_id, condition, result)
);
create index if not exists idx_agg_parent on test_item_aggregate_rules(parent_item_id);
create index if not exists idx_agg_child on test_item_aggregate_rules(child_item_id);
```

## 4. 初始化与示例
- 产品类型示例：'普检产品','特检产品','质谱产品','研发产品','其他产品'
- 套餐类型示例：'常规套餐','科研套餐','VIP套餐'
- 检测项类型示例：'普检检测项','特检检测项','质谱检测项','研发检测项','其他检测项'
- 结果判断类型示例：'上限','下限','上下限','定性','阴阳性','聚合'
- 样本类型示例：'全血','血浆','组织液','尿液','切片'

示例插入：
```sql
-- 插入产品
insert into products (product_code, product_name, product_type)
values ('P001','常规普检产品','普检产品');

-- 插入检测项（上下限）
insert into test_items (item_code, item_name, item_type, judgement_type, limit_upper, limit_lower, unit)
values ('T001','白细胞计数','普检检测项','上下限',10.0,4.0,'10^9/L');

-- 插入检测项（定性）
insert into test_items (item_code, item_name, item_type, judgement_type, qualitative_value)
values ('T002','HBsAg','特检检测项','阴阳性','阴性');

-- 插入套餐
insert into packages (package_code, package_name, package_type)
values ('PK001','基础常规套餐','常规套餐');

-- 套餐绑定产品+样本类型
insert into package_products (package_id, product_id, sample_type)
select pks.id, prd.id, '全血'
from packages pks, products prd
where pks.package_code='PK001' and prd.product_code='P001';
```

## 5. 索引与性能建议
- 为高频过滤字段建立索引（如 `products.product_name`、`test_items.item_name`、`packages.package_name`）
- 组合唯一约束避免重复绑定（如 `package_products` 的 `(package_id, product_id, sample_type)`）
- 对外键字段建立单列索引以提升联接性能

## 6. 安全与访问控制建议
- 推荐开启 RLS（Row Level Security），按业务角色控制写入权限
- `packages`、`products`、`test_items` 表的写操作建议仅限有管理权限的角色

## 7. 运维与演进
- DDL 可通过 Supabase SQL 运行器执行并版本化（如 `001_products.sql`、`002_test_items.sql`、`003_packages.sql`）
- 枚举（类型/状态）可在后续演进为独立字典表以便统一管理与国际化
- `updated_at` 可采用触发器或应用层更新确保变更留痕
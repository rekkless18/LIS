# 客户配置数据库设计（Supabase/PostgreSQL）

## 1. 目标与范围
- 支持“客户配置”页面的增删改查与启用/禁用操作
- 满足查询条件区的多维度检索：客户编码、客户名称、客户类型、区域、状态、创建日期范围
- 与前端路由权限联动（参考权限表项 `config:configcustomer`），在服务端通过角色-权限控制写入权限
- 提供分页、排序、横向滚动等列表显示所需的字段与索引

## 2. 表清单与关联说明
- customers（客户表，核心业务数据）

说明：
- 客户类型与区域在当前版本作为受控枚举存储于 customers 表的文本字段并通过 CHECK 约束约束取值；后续如需国际化与动态管理，可演进为字典表（参考“运维与演进”）

## 3. 字段详细设计

### 3.1 customers（客户表）
- id：uuid，主键，默认 `gen_random_uuid()`
- customer_code：text，客户编码，唯一
- customer_name：text，客户名称
- customer_type：text，枚举（`enterprise`/`university`/`research`）
- region：text，枚举（`mainland`/`hkmotw`/`western_europe`/`southeast_asia`/`middle_east`/`north_america`/`other`）
- status：text，枚举（`enabled`/`disabled`），默认 `enabled`
- created_at：timestamptz，默认 `now()`
- updated_at：timestamptz，默认 `now()`

索引与约束：
- 唯一约束：`uniq_customers_code (customer_code)`
- 常用索引：`idx_customers_name (customer_name)` 模糊查询；`idx_customers_status (status)`；`idx_customers_created (created_at)`；可按需增加复合索引（如 `(customer_type, region)`）

示例DDL：
```sql
create extension if not exists pgcrypto;

create table if not exists customers (
  id uuid primary key default gen_random_uuid(),
  customer_code text not null,
  customer_name text not null,
  customer_type text not null check (customer_type in ('enterprise','university','research')),
  region text not null check (region in ('mainland','hkmotw','western_europe','southeast_asia','middle_east','north_america','other')),
  status text not null check (status in ('enabled','disabled')) default 'enabled',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_customers_code unique (customer_code)
);

create index if not exists idx_customers_name on customers(customer_name);
create index if not exists idx_customers_status on customers(status);
create index if not exists idx_customers_created on customers(created_at);
create index if not exists idx_customers_type_region on customers(customer_type, region);
```

触发器建议（可选）：
- 为 `customers` 定义 `updated_at` 自动更新时间触发器，避免遗漏应用层更新

显示名称建议：
- 前端展示时可基于枚举值进行本地化映射：
  - customer_type：`enterprise→企业客户`、`university→高校客户`、`research→科研客户`
  - region：`mainland→大陆`、`hkmotw→港澳台`、`western_europe→西欧`、`southeast_asia→东南亚`、`middle_east→中东`、`north_america→北美`、`other→其他`

## 4. 查询与交互支持
- 模糊查询（客户名称）：
```sql
select * from customers
where customer_name ilike '%' || :name || '%';
```
- 精确多编码查询（英文逗号分隔）：
```sql
select * from customers
where customer_code = any(string_to_array(:codes, ','));
```
- 多选下拉筛选（客户类型/区域/状态）：
```sql
select * from customers
where customer_type = any(:types)
  and region = any(:regions)
  and status = any(:statuses);
```
- 创建日期范围查询：
```sql
select * from customers
where created_at >= :start and created_at < :end;
```
- 启用/禁用批量更新（勾选多行）：
```sql
update customers
set status = 'enabled', updated_at = now()
where id = any(:ids);

update customers
set status = 'disabled', updated_at = now()
where id = any(:ids);
```
- 排序与分页（示例）：
```sql
select * from customers
where /* 组合筛选条件 */ true
order by created_at desc, customer_code asc
limit :page_size offset (:page_no - 1) * :page_size;
```

## 5. 安全与访问控制（RLS）
- 推荐开启 RLS，并基于“角色-权限”模型控制写入权限；读取权限对 `authenticated` 开放，写入权限仅限 `service_role` 或具备 `config:configcustomer` 权限的角色

示例策略（基础版，可按需细化为权限校验联接）：
```sql
alter table customers enable row level security;

-- 读取：允许所有已认证用户（可在联接用户角色/权限后按需收敛）
create policy p_customers_select_auth on customers for select to authenticated using (true);

-- 写入：仅允许 service_role（后续可改为基于角色-权限的复杂策略）
create policy p_customers_insert_service on customers for insert to service_role with check (true);
create policy p_customers_update_service on customers for update to service_role using (true) with check (true);
create policy p_customers_delete_service on customers for delete to service_role using (true);
```

## 6. 索引与性能建议
- 频繁查询字段（`customer_name`、`customer_code`、`status`、`created_at`）建立索引以优化筛选与排序
- 对组合筛选常见维度（如 `customer_type, region`）建立复合索引以提升性能
- 对模糊查询可根据需求引入 `pg_trgm` 拓展与 GIN 索引（大规模名称检索场景）

## 7. 运维与演进
- 迁移脚本建议：`001_customers.sql`（建表与基础索引）、`002_customers_rls.sql`（RLS策略）
- 枚举值后续可演进为独立字典表：`dict_customer_type`、`dict_region`，以支持国际化与后台维护；并将 `customers.customer_type/region` 改为字典外键
- `updated_at` 可通过触发器自动更新时间（或在应用层统一中间件更新）
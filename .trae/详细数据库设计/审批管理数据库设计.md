# 审批管理数据库设计（Supabase/PostgreSQL）

## 1. 目标与范围
- 支持“审批查询”和“审批流程配置”两类页面的后端数据模型与接口存储。
- 覆盖流程定义、节点配置、审批单实例、节点执行进度与操作日志记录。
- 与现有用户/角色/权限体系（`users`/`roles`/`permissions`）联动，实现基于角色/部门/指定用户的审批人分配与访问控制。

## 2. 表清单与关联说明
- `approval_flows`（审批流程定义表）
- `approval_flow_nodes`（审批流程节点定义表）
- `approval_flow_node_users`（流程节点-指定用户关联表，可选）
- `approval_requests`（审批单实例表）
- `approval_request_nodes`（审批单-节点实例表）
- `approval_request_node_assignees`（审批单节点-执行人关联表，可选）
- `approval_actions`（审批操作日志表）

关联关系说明：
- `approval_flows` 1..* `approval_flow_nodes`（按 `node_order` 排列，表示一级/二级/三级审批）
- `approval_flow_nodes` 1..* `approval_flow_node_users`（当审批人类型为“指定用户”时维护备选用户集合）
- `approval_flows` 1..* `approval_requests`（审批单实例绑定某个流程）
- `approval_requests` 1..* `approval_request_nodes`（实例化流程的每个节点；含当前进度与结果）
- `approval_request_nodes` 1..* `approval_request_node_assignees`（当节点允许多个执行人时维护集合与各自状态）
- `approval_request_nodes` 1..* `approval_actions`（记录提交/通过/驳回/撤回等操作日志）

## 3. 字段详细设计与示例DDL

### 3.0 审批编号与状态映射规则（应用层/展示层）
- 审批单编号：按“审批类型前缀 + 日期(YYYYMMDD) + 4位随机数”生成，示例：
  - 加急申请：`JZ202308010001`
  - 库存采购申请：`KC202308010001`
  - 请假申请：`QJ202308010001`
  - 编号需全局唯一（`approval_requests.request_code` 唯一约束）
- 状态展示映射（数据库 → 页面展示）：
  - `in_progress` → `待审批`
  - `approved` → `已通过`
  - `rejected` → `已驳回`
  - `withdrawn` → `已撤回`
- 流转规则：
  - 申请人提交后：请求 `status='submitted'`，当前节点 `status='pending'`
  - 审批人通过：当前节点置 `approved`，若存在下一节点则请求保持 `submitted`（待审批）；若不存在下一节点则请求置 `approved`
  - 审批人驳回：当前节点置 `rejected`，请求置 `rejected`
  - 申请人撤回：请求置 `withdrawn`

### 3.1 审批流程定义：`approval_flows`
- `id`：uuid，主键，默认 `gen_random_uuid()`
- `flow_code`：text，流程编码，唯一
- `flow_name`：text，流程名称
- `flow_type`：text，枚举（`urgent`/`inventory_purchase`/`leave`），对应页面“加急申请/库存采购申请/请假申请”
- `level`：integer，审批级别，取值 1/2/3
- `description`：text，流程描述，可空
- `status`：text，枚举（`enabled`/`disabled`），默认 `enabled`
- `created_at`/`updated_at`：timestamptz，默认 `now()`

示例DDL：
```sql
create extension if not exists pgcrypto;

create table if not exists approval_flows (
  id uuid primary key default gen_random_uuid(),
  flow_code text not null,
  flow_name text not null,
  flow_type text not null check (flow_type in ('urgent','inventory_purchase','leave')),
  level integer not null check (level in (1,2,3)),
  description text,
  status text not null check (status in ('enabled','disabled')) default 'enabled',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_approval_flows_code unique (flow_code)
);
create index if not exists idx_approval_flows_type on approval_flows(flow_type);
```

### 3.2 审批流程节点定义：`approval_flow_nodes`
- `id`：uuid，主键，默认 `gen_random_uuid()`
- `flow_id`：uuid，外键 `approval_flows(id)`
- `node_order`：integer，节点序号，从 1 开始，最大不超过 `approval_flows.level`
- `approver_type`：text，枚举（`role`/`department_head`/`users`/`direct_leader`/`indirect_leader`）
  - `role`：系统角色（从 `roles` 选择）
  - `department_head`：部门负责人（从固定部门枚举选择）
  - `users`：指定用户集合（绑定到 `approval_flow_node_users`）
  - `direct_leader`：直接上级（运行时计算，先保持为空即可）
  - `indirect_leader`：间接上级（运行时计算，先保持为空即可）
- `role_id`：uuid，可空，外键 `roles(id)`（当 `approver_type='role'` 时使用）
- `department`：text，可空（当 `approver_type='department_head'` 时使用，取值如：销售部/采购部/门诊部/检验科/财务部/人力部/后勤部/行政部/其他/运维部）
- `created_at`/`updated_at`：timestamptz，默认 `now()`

示例DDL：
```sql
create table if not exists approval_flow_nodes (
  id uuid primary key default gen_random_uuid(),
  flow_id uuid not null references approval_flows(id) on delete cascade,
  node_order integer not null,
  approver_type text not null check (approver_type in ('role','department_head','users','direct_leader','indirect_leader')),
  role_id uuid references roles(id) on delete set null,
  department text,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_flow_nodes_order unique (flow_id, node_order)
);
create index if not exists idx_flow_nodes_flow on approval_flow_nodes(flow_id);
create index if not exists idx_flow_nodes_role on approval_flow_nodes(role_id);
```

### 3.3 流程节点-指定用户：`approval_flow_node_users`
- `id`：uuid，主键，默认 `gen_random_uuid()`
- `node_id`：uuid，外键 `approval_flow_nodes(id)`
- `user_id`：uuid，外键 `users(id)`

示例DDL：
```sql
create table if not exists approval_flow_node_users (
  id uuid primary key default gen_random_uuid(),
  node_id uuid not null references approval_flow_nodes(id) on delete cascade,
  user_id uuid not null references users(id) on delete cascade,
  constraint uniq_flow_node_user unique (node_id, user_id)
);
create index if not exists idx_flow_node_users_node on approval_flow_node_users(node_id);
create index if not exists idx_flow_node_users_user on approval_flow_node_users(user_id);
```

### 3.4 审批单实例：`approval_requests`
- `id`：uuid，主键，默认 `gen_random_uuid()`
- `request_code`：text，审批单编号，唯一（页面查询字段）
- `flow_id`：uuid，外键 `approval_flows(id)`
- `flow_type`：text，冗余存储流程类型（`urgent`/`inventory_purchase`/`leave`）
- `level`：integer，冗余存储流程级别（1/2/3）
- `applicant_id`：uuid，申请人，外键 `users(id)`
- `request_content`：text，审批单内容（展示用，供审批人参考）
- `status`：text，枚举（`submitted`/`in_progress`/`approved`/`rejected`/`withdrawn`）
- `created_at`/`updated_at`：timestamptz，默认 `now()`

示例DDL：
```sql
create table if not exists approval_requests (
  id uuid primary key default gen_random_uuid(),
  request_code text not null,
  flow_id uuid not null references approval_flows(id) on delete restrict,
  flow_type text not null check (flow_type in ('urgent','inventory_purchase','leave')),
  level integer not null check (level in (1,2,3)),
  applicant_id uuid not null references users(id) on delete restrict,
  request_content text,
  status text not null check (status in ('submitted','in_progress','approved','rejected','withdrawn')) default 'submitted',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_approval_requests_code unique (request_code)
);
create index if not exists idx_approval_requests_flow on approval_requests(flow_id);
create index if not exists idx_approval_requests_applicant on approval_requests(applicant_id);
create index if not exists idx_approval_requests_status on approval_requests(status);
```

### 3.5 审批单-节点实例：`approval_request_nodes`
- `id`：uuid，主键，默认 `gen_random_uuid()`
- `request_id`：uuid，外键 `approval_requests(id)`
- `node_order`：integer，节点序号，与流程定义对应（1..N）
- `approver_type`：text，枚举（`role`/`department_head`/`users`/`direct_leader`/`indirect_leader`），从流程定义快照
- `role_id`：uuid，可空，外键 `roles(id)`（当 `approver_type='role'`）
- `department`：text，可空（当 `approver_type='department_head'`）
- `status`：text，枚举（`pending`/`approved`/`rejected`），节点当前状态
- `acted_at`：timestamptz，可空，节点达成时间
- `comment`：text，可空，节点备注/意见（如审批理由）

示例DDL：
```sql
create table if not exists approval_request_nodes (
  id uuid primary key default gen_random_uuid(),
  request_id uuid not null references approval_requests(id) on delete cascade,
  node_order integer not null,
  approver_type text not null check (approver_type in ('role','department_head','users','direct_leader','indirect_leader')),
  role_id uuid references roles(id) on delete set null,
  department text,
  status text not null check (status in ('pending','approved','rejected')) default 'pending',
  acted_at timestamptz,
  comment text,
  constraint uniq_request_nodes_order unique (request_id, node_order)
);
create index if not exists idx_request_nodes_request on approval_request_nodes(request_id);
create index if not exists idx_request_nodes_status on approval_request_nodes(status);
```

### 3.6 节点实例-执行人：`approval_request_node_assignees`
- `id`：uuid，主键，默认 `gen_random_uuid()`
- `request_node_id`：uuid，外键 `approval_request_nodes(id)`
- `user_id`：uuid，外键 `users(id)`
- `status`：text，枚举（`pending`/`approved`/`rejected`），执行人个人状态（允许多执行人并行，达成规则由业务决定）
- `acted_at`：timestamptz，可空

示例DDL：
```sql
create table if not exists approval_request_node_assignees (
  id uuid primary key default gen_random_uuid(),
  request_node_id uuid not null references approval_request_nodes(id) on delete cascade,
  user_id uuid not null references users(id) on delete cascade,
  status text not null check (status in ('pending','approved','rejected')) default 'pending',
  acted_at timestamptz,
  constraint uniq_request_node_assignee unique (request_node_id, user_id)
);
create index if not exists idx_request_node_assignees_node on approval_request_node_assignees(request_node_id);
create index if not exists idx_request_node_assignees_user on approval_request_node_assignees(user_id);
```

### 3.7 审批操作日志：`approval_actions`
- `id`：uuid，主键，默认 `gen_random_uuid()`
- `request_node_id`：uuid，外键 `approval_request_nodes(id)`
- `operator_id`：uuid，外键 `users(id)`
- `action`：text，枚举（`submit`/`approve`/`reject`/`withdraw`）
- `reason`：text，操作理由（页面“请填写审批理由”为必填，记录在此）
- `created_at`：timestamptz，默认 `now()`

示例DDL：
```sql
create table if not exists approval_actions (
  id uuid primary key default gen_random_uuid(),
  request_node_id uuid not null references approval_request_nodes(id) on delete cascade,
  operator_id uuid not null references users(id) on delete restrict,
  action text not null check (action in ('submit','approve','reject','withdraw')),
  reason text not null,
  created_at timestamptz not null default now()
);
create index if not exists idx_approval_actions_node on approval_actions(request_node_id);
create index if not exists idx_approval_actions_operator on approval_actions(operator_id);
```

## 4. 运行时同步与触发器建议
- 审批单创建时（插入 `approval_requests` 后）根据 `approval_flow_nodes` 自动实例化 `approval_request_nodes` 与其 `assignees`：
  - 当 `approver_type='users'`：从 `approval_flow_node_users` 复制到 `approval_request_node_assignees`
  - 当 `approver_type='role'`：按角色查询启用用户集合生成 `assignees`
  - 当 `department_head`：按部门负责人规则解析为具体用户（可在应用层或存储过程实现）
  - 当 `direct_leader`/`indirect_leader`：通过组织架构解析申请人的直接/间接上级
- 节点完成时自动推进：当某节点达成“通过/驳回”后，更新对应 `approval_request_nodes.status` 与 `acted_at`，并对 `approval_requests.status` 做整体状态推进。
- 建议在应用层实现复杂的负责人解析逻辑；数据库触发器可用于基础的节点实例化与状态聚合。

## 5. 初始化示例（流程与节点）
```sql
-- 示例流程：加急申请，两级审批
insert into approval_flows (flow_code, flow_name, flow_type, level, description)
values ('FLOW_URGENT_2','加急申请（两级）','urgent',2,'加急场景：运营→部门负责人');

-- 一级节点：系统角色-运营（operator）
insert into approval_flow_nodes (flow_id, node_order, approver_type, role_id)
select f.id, 1, 'role', r.id
from approval_flows f, roles r
where f.flow_code='FLOW_URGENT_2' and r.role_code='operator';

-- 二级节点：部门负责人-检验科
insert into approval_flow_nodes (flow_id, node_order, approver_type, department)
select f.id, 2, 'department_head', '检验科'
from approval_flows f
where f.flow_code='FLOW_URGENT_2';
```

## 6. 索引与性能建议
- 业务主键与常用筛选字段均建立索引：
  - `approval_flows(flow_code, flow_type)` 加速流程管理与筛选
  - `approval_requests(request_code, status, applicant_id)` 加速审批查询页
  - `approval_request_nodes(request_id, node_order, status)` 加速流程进度查询
  - `approval_actions(request_node_id, operator_id)` 加速审计日志查询
- 组合唯一约束确保数据一致性：
  - `uniq_flow_nodes_order (flow_id, node_order)`
  - `uniq_request_nodes_order (request_id, node_order)`

## 7. 安全与访问控制（RLS）建议
- 开启 RLS：`approval_requests`、`approval_request_nodes`、`approval_actions`、`approval_flows`、`approval_flow_nodes`、`approval_flow_node_users`、`approval_request_node_assignees`。
- 读取策略：
  - 申请人可读取自身 `approval_requests` 与相关节点、操作日志。
  - 被分配为执行人的用户可读取对应 `approval_request_nodes`、`assignees` 与 `actions`。
  - 管理角色（如 `admin`/`operator`）可读取全部流程定义与审批数据。
- 写入策略：
  - 提交与撤回由申请人触发；节点“通过/驳回”由被分配执行人触发；流程配置仅管理员可写。
- 配合 Supabase Service Role 对管理操作进行授权；前端认证用户仅按策略读取/写入。

## 8. 运维与演进
- 采用迁移脚本进行版本化（如 `010_approval_flows.sql`、`011_approval_flow_nodes.sql` 等）。
- 后续可将部门、流程类型、状态枚举抽象为字典表统一管理与国际化。
- 可增加 `updated_at` 自动更新时间触发器，或在应用层更新。
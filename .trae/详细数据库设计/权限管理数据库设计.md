# 权限管理数据库设计（Supabase/PostgreSQL）

## 1. 目标与范围
- 以“角色-权限-用户”三层模型实现路由级访问控制
- 权限项与前端页面路由一一对应，可进行分组与启用控制
- 用户可绑定多个角色；角色可绑定多个权限

## 2. 表清单与关联说明
- users（用户表）
- user_credentials（用户凭据表，账户与密码哈希，仅业务库冗余存储）
- roles（角色表）
- permissions（权限表，权限即前端路由）
- user_roles（用户-角色多对多关联表）
- role_permissions（角色-权限多对多关联表）

关联关系说明：
- users 1..* roles（经由 user_roles）
- users 1..1 user_credentials（经由 user_id 或 account 唯一关联）
- roles 1..* permissions（经由 role_permissions）
- permissions 通过 `parent_key` 形成树状分组（例如模块/子模块/页面）

## 3. 字段详细设计

### 3.1 users（用户表）
- id：uuid，主键，默认 `gen_random_uuid()`
- account：text，登录账号，唯一
- name：text，用户姓名
- user_type：text，枚举（internal/external）
- email：text，可空
- phone：text，可空
- status：text，枚举（enabled/disabled）
- last_login_at：timestamptz，可空
- last_password_change_at：timestamptz，可空
- created_at：timestamptz，默认 `now()`
- updated_at：timestamptz，默认 `now()`
- role_ids_str：text，逗号分隔的角色ID冗余字段，用于快速展示绑定角色；通过触发器在 `user_roles` 变更时自动同步，业务更新请写入 `user_roles`

索引与约束：
- 唯一约束：`uniq_users_account (account)`
- 常用索引：`idx_users_name (name)`

示例DDL：
```sql
create extension if not exists pgcrypto;

create table if not exists users (
  id uuid primary key default gen_random_uuid(),
  account text not null,
  name text not null,
  user_type text not null check (user_type in ('internal','external')),
  email text,
  phone text,
  status text not null check (status in ('enabled','disabled')) default 'enabled',
  last_login_at timestamptz,
  last_password_change_at timestamptz,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_users_account unique (account)
);
create index if not exists idx_users_name on users(name);
```

触发器同步说明：
- 为 `users` 增加 `role_ids_str` 后，需创建同步函数与触发器，在 `user_roles` 的插入/删除/更新时，自动聚合该用户的所有 `role_id` 为逗号字符串并写入 `users.role_ids_str`
- 示例脚本参考：`add_users_roles_sync.sql`

### 3.2 roles（角色表）
- id：uuid，主键，默认 `gen_random_uuid()`
- role_code：text，角色编码，唯一
- role_name：text，角色名称
- role_type：text，枚举（internal/external）
- status：text，枚举（enabled/disabled）
- created_at：timestamptz，默认 `now()`
- updated_at：timestamptz，默认 `now()`

示例DDL：
```sql
create table if not exists roles (
  id uuid primary key default gen_random_uuid(),
  role_code text not null,
  role_name text not null,
  role_type text not null check (role_type in ('internal','external')),
  status text not null check (status in ('enabled','disabled')) default 'enabled',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_roles_code unique (role_code)
);
```

### 3.3 permissions（权限表，权限即前端路由）
- id：uuid，主键，默认 `gen_random_uuid()`
- perm_key：text，权限唯一键（建议规则：将`/`转为`:`，如`/config/configreport`→`config:configreport`），唯一
- perm_name：text，权限名称（展示用）
- parent_key：text，上级权限键（可空）
- route_path：text，前端页面路由路径，唯一
- enabled：boolean，是否启用，默认 true
- created_at：timestamptz，默认 `now()`
- updated_at：timestamptz，默认 `now()`

示例DDL：
```sql
create table if not exists permissions (
  id uuid primary key default gen_random_uuid(),
  perm_key text not null,
  perm_name text not null,
  parent_key text,
  route_path text not null,
  enabled boolean not null default true,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_permissions_key unique (perm_key),
  constraint uniq_permissions_route unique (route_path)
);
create index if not exists idx_permissions_parent on permissions(parent_key);
```

### 3.4 user_roles（用户-角色关联表）
- id：uuid，主键，默认 `gen_random_uuid()`
- user_id：uuid，外键 `users(id)`
- role_id：uuid，外键 `roles(id)`
- created_at：timestamptz，默认 `now()`

示例DDL：
```sql
create table if not exists user_roles (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references users(id) on delete cascade,
  role_id uuid not null references roles(id) on delete cascade,
  created_at timestamptz not null default now(),
  constraint uniq_user_roles unique (user_id, role_id)
);
create index if not exists idx_user_roles_user on user_roles(user_id);
create index if not exists idx_user_roles_role on user_roles(role_id);
```

### 3.5 role_permissions（角色-权限关联表）
- id：uuid，主键，默认 `gen_random_uuid()`
- role_id：uuid，外键 `roles(id)`
- permission_id：uuid，外键 `permissions(id)`
- created_at：timestamptz，默认 `now()`

示例DDL：
```sql
create table if not exists role_permissions (
  id uuid primary key default gen_random_uuid(),
  role_id uuid not null references roles(id) on delete cascade,
  permission_id uuid not null references permissions(id) on delete cascade,
  created_at timestamptz not null default now(),
  constraint uniq_role_permissions unique (role_id, permission_id)
);
create index if not exists idx_role_permissions_role on role_permissions(role_id);
create index if not exists idx_role_permissions_permission on role_permissions(permission_id);
```

## 4. 权限初始化说明（路由→权限）
- 权限来源：当前前端已定义的页面路由
- 归一规则：`perm_key = route_path` 去掉前导 `/` 后将 `/` 替换为 `:`；例如：
  - `/permission/user` → `permission:user`
  - `/permission/role` → `permission:role`
  - `/inventory/inventoryquery` → `inventory:inventoryquery`
  - `/approval/approvalquery` → `approval:approvalquery`
  - `/report/generate`、`/report/audit`、`/report/query`、`/report/exception`
  - `/config/configreport`、`/config/configtech-route`、`/config/configexperiment`、`/config/configapproval`
  - `/config/configpackage`、`/config/configproduct`、`/config/configtest-item`、`/config/configcustomer`
  - `/labmanage/environmentmanage`、`/labmanage/equipmentmanage`
  - `/test/routine/routineexperiment`
  - `/special/specialaudit`、`/special/specialexception`
  - `/ms/msexperiment`、`/ms/msaudit`、`/ms/msexception`
  - `/system/global`
- 分组规则：`parent_key` 使用一级模块名（如 `permission`、`config`、`report`、`labmanage`、`inventory`、`approval`、`test`、`special`、`ms`、`system`）
- 启用控制：默认全部 `enabled=true`，后续可按需关闭

示例初始化SQL（插入部分权限项）：
```sql
insert into permissions (perm_key, perm_name, parent_key, route_path)
values 
('permission:user','用户配置','permission','/permission/user'),
('permission:role','角色配置','permission','/permission/role'),
('inventory:inventoryquery','库存查询','inventory','/inventory/inventoryquery'),
('approval:approvalquery','审批查询','approval','/approval/approvalquery'),
('report:generate','报告生成','report','/report/generate'),
('report:audit','报告审核','report','/report/audit'),
('report:query','报告查询','report','/report/query'),
('report:exception','报告异常处理','report','/report/exception'),
('config:configreport','报告配置','config','/config/configreport'),
('config:configtech-route','特检技术路线配置','config','/config/configtech-route'),
('config:configexperiment','实验配置','config','/config/configexperiment'),
('config:configapproval','审批配置','config','/config/configapproval'),
('config:configpackage','套餐配置','config','/config/configpackage'),
('config:configproduct','产品配置','config','/config/configproduct'),
('config:configtest-item','检测项配置','config','/config/configtest-item'),
('config:configcustomer','客户配置','config','/config/configcustomer'),
('labmanage:environmentmanage','环境管理','labmanage','/labmanage/environmentmanage'),
('labmanage:equipmentmanage','设备管理','labmanage','/labmanage/equipmentmanage'),
('test:routine:routineexperiment','普检实验','test','/test/routine/routineexperiment'),
('special:specialaudit','特检数据审核','special','/special/specialaudit'),
('special:specialexception','特检异常处理','special','/special/specialexception'),
('ms:msexperiment','质谱实验','ms','/ms/msexperiment'),
('ms:msaudit','质谱数据审核','ms','/ms/msaudit'),
('ms:msexception','质谱异常处理','ms','/ms/msexception'),
('system:global','全局配置','system','/system/global'),
('home','首页','home','/home'),
('order','订单管理','order','/order'),
('order:orderquery','订单查询','order','/order/orderquery'),
('order:sample','样本进度查询','order','/order/sample'),
('order:delivery','交付下载','order','/order/delivery'),
('order:report::id:preview','报告预览','order','/order/report/:id/preview'),
('order:product:new','产品订单新建','order','/order/product/new'),
('order:package:new','套餐订单新建','order','/order/package/new'),
('order:product::id:edit','产品订单编辑','order','/order/product/:id/edit'),
('order:package::id:edit','套餐订单编辑','order','/order/package/:id/edit'),
('order:product::id','产品订单详情','order','/order/product/:id'),
('order:package::id','套餐订单详情','order','/order/package/:id'),
('logistics','物流管理','logistics','/logistics'),
('logistics:logisticsquery','物流查询','logistics','/logistics/logisticsquery'),
('samples','样本管理','samples','/samples'),
('samples:samplesquery','样本查询','samples','/samples/samplesquery'),
('samples:receive','样本接收','samples','/samples/receive'),
('test','实验管理','test','/test'),
('test:routine:routineexception','普检异常处理','test','/test/routine/routineexception'),
('test:routine:exception','普检异常处理','test','/test/routine/exception'),
('test:special:tech-route','技术路线确认','test','/test/special/tech-route'),
('test:special:preprocess','预处理','test','/test/special/preprocess'),
('test:special:pre-run','上机前处理','test','/test/special/pre-run'),
('test:special:sequencing','测序上机','test','/test/special/sequencing'),
('test:special:bioinfo','生信分析','test','/test/special/bioinfo'),
('test:special:qpcr','QPCR分析','test','/test/special/qpcr'),
('test:special:specialaudit','特检数据审核','test','/test/special/specialaudit'),
('test:special:specialexception','特检异常处理','test','/test/special/specialexception'),
('test:ms:msexperiment','质谱实验','test','/test/ms/msexperiment'),
('test:ms:msaudit','质谱数据审核','test','/test/ms/msaudit'),
('test:ms:msexception','质谱异常处理','test','/test/ms/msexception'),
('report','报告管理','report','/report');
```

## 5. 角色与用户初始化示例

### 5.1 角色初始化
```sql
insert into roles (role_code, role_name, role_type)
values
('admin','系统管理员','internal'),
('operator','业务运营','internal'),
('viewer','只读访客','external');
```

### 5.2 角色-权限绑定
- 管理员：绑定全部权限
- 运营：绑定除“权限管理”与“系统管理”外的大部分业务页面
- 访客：仅绑定查询类页面（库存/审批/报告查询）

示例SQL：
```sql
-- 管理员绑定全部权限
insert into role_permissions (role_id, permission_id)
select r.id, p.id
from roles r
join permissions p on true
where r.role_code = 'admin';

-- 访客绑定少量只读页面
insert into role_permissions (role_id, permission_id)
select r.id, p.id
from roles r
join permissions p on p.perm_key in (
  'inventory:inventoryquery',
  'approval:approvalquery',
  'report:query'
)
where r.role_code = 'viewer';
```

### 5.3 用户初始化与绑定角色
```sql
-- 新建两个用户
insert into users (account, name, user_type, email, status)
values
('admin','管理员','internal','admin@example.com','enabled'),
('alice','艾丽丝','external','alice@example.com','enabled');

-- 绑定用户角色
insert into user_roles (user_id, role_id)
select u.id, r.id from users u, roles r
where u.account = 'admin' and r.role_code = 'admin';

insert into user_roles (user_id, role_id)
select u.id, r.id from users u, roles r
where u.account = 'alice' and r.role_code = 'viewer';
```

## 6. 索引与性能建议
- `permissions(route_path)` 与 `permissions(parent_key)` 建索引以加速菜单加载与分组查询
- `user_roles(user_id, role_id)`、`role_permissions(role_id, permission_id)` 组合唯一约束避免重复绑定，同时对各自外键单列建索引以提升联接性能
- 频繁查询字段（如 `users.account`、`roles.role_code`、`permissions.perm_key`）建议建立唯一或普通索引

## 7. 安全与访问控制建议
- Supabase 推荐开启 RLS（Row Level Security），在 `users`、`user_roles`、`role_permissions`、`permissions`、`roles` 上分别定义策略
- 读取策略可基于当前会话的用户标识（JWT Claims）联接角色与权限后判定是否允许访问
- 后续可将“按钮级权限”细化为操作码（如 `report:query:download`）以实现更精细的授权

## 8. 运维与演进
- 所有 DDL 均可通过 Supabase SQL 运行器执行；版本化建议采用迁移脚本（如 `001_permissions.sql`、`002_roles.sql` 等）
- 枚举（状态/类型）可在后续演进为独立字典表以便统一管理与国际化
- `updated_at` 建议在应用层更新，或使用触发器自动更新（可在后续补充触发器方案）
### 3.6 user_credentials（用户凭据表，账户与密码哈希）
- id：uuid，主键，默认 `gen_random_uuid()`
- user_id：uuid，外键 `users(id)`，唯一（一个用户仅一条凭据记录）
- account：text，外键 `users(account)`，唯一（与用户表保持一致）
- password_hash：text，密码哈希（仅存哈希，禁止存明文）
- password_algo：text，哈希算法标识（如 `bcrypt`），默认 `bcrypt`
- password_version：integer，哈希版本（用于后续算法迭代），默认 `1`
- password_status：text，枚举（`active`/`revoked`），默认 `active`
- last_password_change_at：timestamptz，最后修改时间，默认 `now()`
- created_at：timestamptz，默认 `now()`
- updated_at：timestamptz，默认 `now()`

说明与约束：
- 与 `users` 强一致关联；账号与密码的更新应通过后端安全逻辑进行，仅存储哈希（推荐 `bcrypt`），禁止存明文或可反推数据
- 建议仅允许服务端（Service Role）访问此表；前端与普通认证用户不可读取

示例DDL与策略（RLS）：
```sql
create extension if not exists pgcrypto;

create table if not exists user_credentials (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references users(id) on delete cascade,
  account text not null references users(account) on delete cascade,
  password_hash text not null,
  password_algo text not null default 'bcrypt',
  password_version integer not null default 1,
  password_status text not null check (password_status in ('active','revoked')) default 'active',
  last_password_change_at timestamptz not null default now(),
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_user_credentials_user unique (user_id),
  constraint uniq_user_credentials_account unique (account)
);

alter table user_credentials enable row level security;
-- 仅允许 service_role 访问（服务端密钥），拒绝普通 authenticated 用户
create policy p_user_credentials_select_service on user_credentials for select to service_role using (true);
create policy p_user_credentials_insert_service on user_credentials for insert to service_role with check (true);
create policy p_user_credentials_update_service on user_credentials for update to service_role using (true) with check (true);
create policy p_user_credentials_delete_service on user_credentials for delete to service_role using (true);
```
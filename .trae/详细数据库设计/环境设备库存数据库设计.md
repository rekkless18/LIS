# 环境设备库存数据库设计（Supabase/PostgreSQL）

## 1. 目标与范围
- 支持环境管理、设备管理、库存查询三类页面的增删改查与筛选
- 满足查询条件区的多维度检索与列表展示字段需求
- 与权限路由联动：`labmanage:environmentmanage`、`labmanage:equipmentmanage`、`inventory:inventoryquery`
- 提供分页、排序与性能优化的索引与示例 SQL

## 2. 表清单与关联说明
- rooms（房间/环境基础信息表）
- environment_readings（环境监测读数表，按时间序列记录温湿度压强）
- equipment（设备基础信息表）
- equipment_responsibles（设备-责任人关联表，关联 `users`）
- inventory_items（库存物料表，含数量与阈值等级）

关联关系：
- rooms 1..* environment_readings（一个房间多条监测记录）
- equipment 1..* equipment_responsibles → users（设备可绑定多个责任人）

## 3. 字段与DDL设计

### 3.1 rooms（房间/环境基础信息表）
- id：uuid，主键，默认 `gen_random_uuid()`
- room_code：text，房间号，唯一
- room_location：text，房间位置
- protection_level：text，枚举（`level1`/`level2`/`level3`）
- status：text，枚举（`normal`/`abnormal`）
- created_at：timestamptz，默认 `now()`
- updated_at：timestamptz，默认 `now()`

索引与约束：
- 唯一约束：`uniq_rooms_code (room_code)`
- 常用索引：`idx_rooms_location (room_location)`、`idx_rooms_status (status)`、`idx_rooms_level (protection_level)`、`idx_rooms_created (created_at)`

示例DDL：
```sql
create extension if not exists pgcrypto;

create table if not exists rooms (
  id uuid primary key default gen_random_uuid(),
  room_code text not null,
  room_location text not null,
  protection_level text not null check (protection_level in ('level1','level2','level3')),
  status text not null check (status in ('normal','abnormal')),
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_rooms_code unique (room_code)
);

create index if not exists idx_rooms_location on rooms(room_location);
create index if not exists idx_rooms_status on rooms(status);
create index if not exists idx_rooms_level on rooms(protection_level);
create index if not exists idx_rooms_created on rooms(created_at);
```

### 3.2 environment_readings（环境监测读数表）
- id：uuid，主键，默认 `gen_random_uuid()`
- room_id：uuid，外键 `rooms(id)`
- temperature：numeric(6,2)，温度（℃）
- humidity：numeric(5,2)，湿度（%）
- pressure：numeric(8,3)，压强（kPa 或自定义单位）
- reading_at：timestamptz，读数时间
- created_at：timestamptz，默认 `now()`

索引与约束：
- 常用索引：`idx_env_readings_room_time (room_id, reading_at desc)`、`idx_env_readings_room (room_id)`

示例DDL：
```sql
create table if not exists environment_readings (
  id uuid primary key default gen_random_uuid(),
  room_id uuid not null references rooms(id) on delete cascade,
  temperature numeric(6,2),
  humidity numeric(5,2),
  pressure numeric(8,3),
  reading_at timestamptz not null,
  created_at timestamptz not null default now()
);

create index if not exists idx_env_readings_room_time on environment_readings(room_id, reading_at desc);
create index if not exists idx_env_readings_room on environment_readings(room_id);
```

### 3.3 equipment（设备基础信息表）
- id：uuid，主键，默认 `gen_random_uuid()`
- device_code：text，设备编号，唯一
- device_name：text，设备名称
- device_type：text，枚举（`sequencer`/`qpcr`/`centrifuge`/`incubator`/`biochemical`/`mass_spectrometer`/`hematology`/`refrigerator`/`other`）
- device_status：text，枚举（`running`/`shutdown`/`maintenance`/`fault`/`scrapped`）
- device_location：text，设备位置
- manufacturer：text，生产厂家
- purchase_date：date，购置日期
- last_maintenance_date：date，上次维护日期
- scrap_date：date，报废日期，可空
- created_at：timestamptz，默认 `now()`
- updated_at：timestamptz，默认 `now()`

索引与约束：
- 唯一约束：`uniq_equipment_code (device_code)`
- 常用索引：`idx_equipment_name (device_name)`、`idx_equipment_type (device_type)`、`idx_equipment_status (device_status)`、`idx_equipment_location (device_location)`、`idx_equipment_purchase (purchase_date)`、`idx_equipment_maint (last_maintenance_date)`、`idx_equipment_scrap (scrap_date)`

示例DDL：
```sql
create table if not exists equipment (
  id uuid primary key default gen_random_uuid(),
  device_code text not null,
  device_name text not null,
  device_type text not null check (device_type in ('sequencer','qpcr','centrifuge','incubator','biochemical','mass_spectrometer','hematology','refrigerator','other')),
  device_status text not null check (device_status in ('running','shutdown','maintenance','fault','scrapped')),
  device_location text not null,
  manufacturer text,
  purchase_date date,
  last_maintenance_date date,
  scrap_date date,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint uniq_equipment_code unique (device_code)
);

create index if not exists idx_equipment_name on equipment(device_name);
create index if not exists idx_equipment_type on equipment(device_type);
create index if not exists idx_equipment_status on equipment(device_status);
create index if not exists idx_equipment_location on equipment(device_location);
create index if not exists idx_equipment_purchase on equipment(purchase_date);
create index if not exists idx_equipment_maint on equipment(last_maintenance_date);
create index if not exists idx_equipment_scrap on equipment(scrap_date);
```

### 3.4 equipment_responsibles（设备-责任人关联表）
- id：uuid，主键，默认 `gen_random_uuid()`
- equipment_id：uuid，外键 `equipment(id)`
- user_id：uuid，外键 `users(id)`（引用权限设计中的 `users`）
- created_at：timestamptz，默认 `now()`

索引与约束：
- 唯一约束：`uniq_equipment_responsible (equipment_id, user_id)`
- 常用索引：`idx_equipment_responsibles_equipment (equipment_id)`、`idx_equipment_responsibles_user (user_id)`

示例DDL：
```sql
create table if not exists equipment_responsibles (
  id uuid primary key default gen_random_uuid(),
  equipment_id uuid not null references equipment(id) on delete cascade,
  user_id uuid not null references users(id) on delete cascade,
  created_at timestamptz not null default now(),
  constraint uniq_equipment_responsible unique (equipment_id, user_id)
);

create index if not exists idx_equipment_responsibles_equipment on equipment_responsibles(equipment_id);
create index if not exists idx_equipment_responsibles_user on equipment_responsibles(user_id);
```

### 3.5 inventory_items（库存物料表）
- id：uuid，主键，默认 `gen_random_uuid()`
- material_code：text，物料编号，唯一
- material_name：text，物料名称
- manufacturer：text，生产厂家
- batch_no：text，批次号
- expiry_date：date，有效期
- created_at：timestamptz，默认 `now()`
- updated_at：timestamptz，默认 `now()`
- quantity：integer，数量
- threshold_level：text，枚举（`out`/`low`/`medium`/`high`）

索引与约束：
- 唯一约束：`uniq_inventory_code (material_code)`
- 常用索引：`idx_inventory_name (material_name)`、`idx_inventory_manu (manufacturer)`、`idx_inventory_batch (batch_no)`、`idx_inventory_expiry (expiry_date)`、`idx_inventory_threshold (threshold_level)`、`idx_inventory_created (created_at)`

示例DDL：
```sql
create table if not exists inventory_items (
  id uuid primary key default gen_random_uuid(),
  material_code text not null,
  material_name text not null,
  manufacturer text,
  batch_no text,
  expiry_date date,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  quantity integer not null,
  threshold_level text not null check (threshold_level in ('out','low','medium','high')),
  constraint uniq_inventory_code unique (material_code)
);

create index if not exists idx_inventory_name on inventory_items(material_name);
create index if not exists idx_inventory_manu on inventory_items(manufacturer);
create index if not exists idx_inventory_batch on inventory_items(batch_no);
create index if not exists idx_inventory_expiry on inventory_items(expiry_date);
create index if not exists idx_inventory_threshold on inventory_items(threshold_level);
create index if not exists idx_inventory_created on inventory_items(created_at);
```

## 4. 查询与交互支持

### 4.1 环境管理（rooms + 最新读数）
- 房间号精确多值：
```sql
select r.*, er.temperature, er.humidity, er.pressure, er.reading_at
from rooms r
left join (
  select distinct on (room_id) room_id, temperature, humidity, pressure, reading_at
  from environment_readings
  order by room_id, reading_at desc
) er on er.room_id = r.id
where r.room_code = any(string_to_array(:room_codes, ','));
```
- 房间位置模糊：
```sql
... and r.room_location ilike '%' || :location || '%'
```
- 状态/防护等级多选：
```sql
... and r.status = any(:statuses) and r.protection_level = any(:levels)
```
- 排序与分页：
```sql
order by r.created_at desc, r.room_code asc
limit :page_size offset (:page_no - 1) * :page_size;
```

### 4.2 设备管理（equipment）
- 编号精确多值、名称/位置/厂家模糊、类型/状态多选、日期范围：
```sql
select e.*
from equipment e
where (:codes is null or e.device_code = any(string_to_array(:codes, ',')))
  and (:name is null or e.device_name ilike '%' || :name || '%')
  and (:loc is null or e.device_location ilike '%' || :loc || '%')
  and (:manu is null or e.manufacturer ilike '%' || :manu || '%')
  and (coalesce(:types, array[]::text[]) = array[]::text[] or e.device_type = any(:types))
  and (coalesce(:statuses, array[]::text[]) = array[]::text[] or e.device_status = any(:statuses))
  and (:purchase_start is null or e.purchase_date >= :purchase_start)
  and (:purchase_end is null or e.purchase_date < :purchase_end)
  and (:maint_start is null or e.last_maintenance_date >= :maint_start)
  and (:maint_end is null or e.last_maintenance_date < :maint_end)
  and (:scrap_start is null or e.scrap_date >= :scrap_start)
  and (:scrap_end is null or e.scrap_date < :scrap_end)
order by e.created_at desc
limit :page_size offset (:page_no - 1) * :page_size;
```
- 责任人筛选（多选用户ID）：
```sql
and exists (
  select 1 from equipment_responsibles er
  where er.equipment_id = e.id
    and er.user_id = any(:user_ids)
)
```

### 4.3 库存查询（inventory_items）
- 物料编号精确多值、名称/厂家/批次模糊、有效期与创建日期范围、阈值多选：
```sql
select * from inventory_items i
where (:codes is null or i.material_code = any(string_to_array(:codes, ',')))
  and (:name is null or i.material_name ilike '%' || :name || '%')
  and (:manu is null or i.manufacturer ilike '%' || :manu || '%')
  and (:batch is null or i.batch_no ilike '%' || :batch || '%')
  and (:created_start is null or i.created_at >= :created_start)
  and (:created_end is null or i.created_at < :created_end)
  and (:expiry_start is null or i.expiry_date >= :expiry_start)
  and (:expiry_end is null or i.expiry_date < :expiry_end)
  and (coalesce(:levels, array[]::text[]) = array[]::text[] or i.threshold_level = any(:levels))
order by i.created_at desc, i.material_code asc
limit :page_size offset (:page_no - 1) * :page_size;
```

## 5. 安全与访问控制（RLS）
- 推荐开启 RLS，并基于“角色-权限”模型控制写入权限；读取权限对 `authenticated` 开放，写入权限仅限 `service_role` 或后续基于角色-权限策略

示例策略（基础版，可按需细化为权限校验联接）：
```sql
-- rooms
alter table rooms enable row level security;
create policy p_rooms_select_auth on rooms for select to authenticated using (true);
create policy p_rooms_insert_service on rooms for insert to service_role with check (true);
create policy p_rooms_update_service on rooms for update to service_role using (true) with check (true);
create policy p_rooms_delete_service on rooms for delete to service_role using (true);

-- environment_readings（通常仅服务写入）
alter table environment_readings enable row level security;
create policy p_env_select_auth on environment_readings for select to authenticated using (true);
create policy p_env_insert_service on environment_readings for insert to service_role with check (true);
create policy p_env_update_service on environment_readings for update to service_role using (true) with check (true);
create policy p_env_delete_service on environment_readings for delete to service_role using (true);

-- equipment
alter table equipment enable row level security;
create policy p_equipment_select_auth on equipment for select to authenticated using (true);
create policy p_equipment_insert_service on equipment for insert to service_role with check (true);
create policy p_equipment_update_service on equipment for update to service_role using (true) with check (true);
create policy p_equipment_delete_service on equipment for delete to service_role using (true);

-- equipment_responsibles
alter table equipment_responsibles enable row level security;
create policy p_eqresp_select_auth on equipment_responsibles for select to authenticated using (true);
create policy p_eqresp_insert_service on equipment_responsibles for insert to service_role with check (true);
create policy p_eqresp_update_service on equipment_responsibles for update to service_role using (true) with check (true);
create policy p_eqresp_delete_service on equipment_responsibles for delete to service_role using (true);

-- inventory_items
alter table inventory_items enable row level security;
create policy p_inventory_select_auth on inventory_items for select to authenticated using (true);
create policy p_inventory_insert_service on inventory_items for insert to service_role with check (true);
create policy p_inventory_update_service on inventory_items for update to service_role using (true) with check (true);
create policy p_inventory_delete_service on inventory_items for delete to service_role using (true);
```

权限路由建议：
- `labmanage:environmentmanage`：rooms/environment_readings 写入权限
- `labmanage:equipmentmanage`：equipment/equipment_responsibles 写入权限
- `inventory:inventoryquery`：inventory_items 读取权限（如需新建/编辑/删除，可增加操作码权限）

## 6. 索引与性能建议
- 对频繁查询字段（位置/状态/等级/类型/厂家/批次/日期/阈值）建立索引，加速筛选
- 环境最新读数查询建议使用 `distinct on` 或 LATERAL 子查询并确保 `(room_id, reading_at desc)` 索引
- 名称模糊搜索较多时可考虑 `pg_trgm` + GIN 索引（例如设备/物料名称）

## 7. 显示与国际化建议
- 枚举值与中文显示映射（前端或字典表）：
  - protection_level：`level1→一级`、`level2→二级`、`level3→三级`
  - status：`normal→正常`、`abnormal→异常`
  - device_type：`sequencer→测序仪`、`qpcr→QPCR仪`、`centrifuge→离心机`、`incubator→培养箱`、`biochemical→生化仪器`、`mass_spectrometer→质谱仪器`、`hematology→血液仪器`、`refrigerator→冰箱`、`other→其他`
  - device_status：`running→运行`、`shutdown→关机`、`maintenance→维护`、`fault→故障`、`scrapped→报废`
  - threshold_level：`out→告罄`、`low→低`、`medium→中`、`high→高`

## 8. 运维与演进
- 迁移脚本建议：`001_rooms.sql`、`002_environment_readings.sql`、`003_equipment.sql`、`004_equipment_responsibles.sql`、`005_inventory_items.sql` 与对应 RLS 脚本
- 后续可将枚举升级为独立字典表以支持国际化与后台维护，并将字段改为字典外键
- 为 `updated_at` 增加自动更新时间触发器，避免应用层遗漏